// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.14/esri/copyright.txt for details.
//>>built
define("esri/dijit/ObliqueViewer","dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../tasks/QueryTask ../tasks/query ./_EventedWidget dijit/_Widget ./_ObliqueRotationWidget dojo/_base/array ../ImageSpatialReference ../tasks/ImageServiceProjectTask ../tasks/ProjectParameters ../layers/MosaicRule ../geometry/Extent ../geometry/Polygon ../lang ../config ./RasterList dojo/store/Observable dojo/store/Memory dojo/Deferred".split(" "),function(g,l,w,x,y,s,z,A,B,h,C,D,E,m,n,p,q,e,F,t,u,v){g=g([z,A],
{declaredClass:"esri.dijit.ObliqueViewer",azimuthField:"SensorAzimuth",elevationThreshold:70,elevationField:"SensorElevation",snap:!0,_refreshOK:!0,isNadir:!1,showThumbnail:!0,noQueryOnExtentChange:!1,azimuthTolerance:10,rasterListRefresh:!0,_isICS:function(a){return!(!a.ics&&!a.icsid)},_initializeTasks:function(){this.obliqueRecordsQueryTask=new y(this.imageServiceUrl);this.projectTask=new D},_verifyRasterInfoFields:function(){return this.rasterInfoFields&&this.rasterInfoFields.length},_setupRasterList:function(){var a=
this,c=[{name:this.imageServiceLayer.objectIdField,alias:"Object ID",display:!0},{name:this.azimuthField,alias:"Azimuth",display:!0},{name:this.elevationField,alias:this.elevationField,display:!0}];this.rasterInfoFields=this._verifyRasterInfoFields()?this.rasterInfoFields:c;this.rasterList=new F({data:new t(new u),showThumbnail:this.showThumbnail,imageServiceUrl:this.imageServiceLayer.url,fields:this.rasterInfoFields},this.rasterListDiv);this.rasterList.on("raster-select",function(b){a.selectedRasterId=
b[a.imageServiceLayer.objectIdField];a.setImage(a.selectedRasterId,a.map.extent);h.forEach(a.filteredRecords,function(b){delete b.attributes.selected;b.attributes[a.imageServiceLayer.objectIdField]===a.selectedRasterId&&(b.attributes.selected=!0)});a._rotationWidget&&a._rotationWidget.setAzimuth(b[a.azimuthField])});this.rasterList.startup()},_setupRotationWidget:function(){var a=this;this._rotationWidget=new B({snap:this.snap,azimuthAngle:this.azimuthAngle},this.rotationDiv);this._rotationWidget.startup();
this.own(this._rotationWidget.on("azimuth-change",function(c){c=c.azimuth;a.emit("azimuth-change",{azimuth:c});c?(a.isNadir=!1,a.azimuthAngle=c,a._filterByAzimuth(),a._rotationWidget.refresh({features:a.records}),a._refreshListDijit(a.filteredRecords),a._refreshImage(a.map.extent)):a._switchToNadir()}))},_refreshListDijit:function(a){a=this._prepareListData(a);this.rasterList&&this.rasterListRefresh&&this.rasterList.setData(a);this.emit("records-refresh",{records:this.records,filteredRecords:this.filteredRecords})},
_prepareListData:function(a){var c=[],b,d=this.imageServiceLayer.objectIdField;h.forEach(a,function(a){b=a.attributes;b.thumbnailUrl=this.imageServiceUrl+"/"+b[d]+"/thumbnail";c.push(b)},this);return new t(new u({data:c,idProperty:this.imageServiceLayer.objectIdField}))},_switchToNadir:function(){var a=!!this.map.extent.spatialReference.icsid,c=new m;c.method=m.METHOD_NONE;c.where=this.elevationField+"\x3e"+this.elevationThreshold;this.imageServiceLayer.setMosaicRule(c,a);if(a){var b=this,d;this.projectGeometry(this.map.extent,
this.nadirSpatialReference).then(function(a){b._verifyExtent(a[0])&&(b._refreshOK=!1,b.map.spatialReference=a[0].spatialReference,d=e.defaults.map.zoomDuration,e.defaults.map.zoomDuration=0,b.map.setExtent((new n(a[0])).setSpatialReference(a[0].spatialReference)).then(function(){b._refreshOK=!0;b.isNadir=!0;e.defaults.map.zoomDuration=d;b.selectedRasterId=null;b.selectedRaster=null;b.filteredRecords=null}))})}},projectGeometry:function(a,c){var b=new E;c=c||this.map.spatialReference;b.geometries=
[a];b.outSR=c;return this.projectTask.execute(b)},_verifyExtent:function(a){return!isNaN(a.xmin)&&!isNaN(a.xmax)&&!isNaN(a.ymin)&&!isNaN(a.ymax)},_refreshRecords:function(a){function c(c){b._verifyExtent(c[0])?(b.nadirExtent=c[0],b.search(b.nadirExtent).then(function(c){if(!c||!c.features||!c.features.length)return console.log("Oblique viewer: no records returned");b.records=c.features;b._rotationWidget&&b._rotationWidget.refresh({features:b.records});b.isNadir?b._refreshListDijit(b.records):(b._filterByAzimuth(),
b._refreshListDijit(b.filteredRecords),a&&(b.filteredRecords&&b.filteredRecords.length)&&b._refreshImage(b.map.extent))})):(console.error("Oblique viewer: Project Operation returned invalid extent"),b.search(b.map.extent).then(function(c){if(!c||!c.features||!c.features.length)return console.log("Oblique viewer: no records returned");b.records=c.features;b._rotationWidget&&b._rotationWidget.refresh({features:b.records});b.isNadir?b._refreshListDijit(b.records):(b._filterByAzimuth(),b._refreshListDijit(b.filteredRecords),
a&&(b.filteredRecords&&b.filteredRecords.length)&&b._refreshImage((new p(b.filteredRecords[0].geometry)).getExtent()))}))}var b=this;this.nadirSpatialReference.equals(this.map.extent.spatialReference)?c([this.map.extent]):this.projectGeometry(this.map.extent,this.nadirSpatialReference).then(c)},postCreate:function(){this.inherited(arguments);(!this.map||!this.imageServiceLayer)&&console.error("ObliqueViewer: Map or Image service layer not provided.");this.imageServiceUrl=this.imageServiceLayer.url;
this.nadirSpatialReference=this.map.extent.spatialReference;this._initializeTasks();(this.isNadir=!q.isDefined(this.azimuthAngle))&&this._switchToNadir();this.rotationDiv&&this._setupRotationWidget();if(this.rasterListDiv)if(this.imageServiceLayer.loaded)this._setupRasterList();else this.imageServiceLayer.on("load",l.hitch(this,this._setupRasterList));this.sorter||(this.sorter=this._sortSpatially);this.own(this.map.on("extent-change",l.hitch(this,function(a){this._refreshOK&&!this.noQueryOnExtentChange&&
(this._isICS(this.map.extent.spatialReference)||(this._nadirExtent=this.map.extent,this._switchToNadir()),this._refreshRecords(!0))})));q.isDefined(this.azimuthAngle)&&!this.noQueryOnExtentChange&&this._refreshRecords()},_refreshImage:function(a){this.filteredRecords&&(this.filteredRecords.length&&this.selectedRasterId!==this.filteredRecords[0].attributes[this.imageServiceLayer.objectIdField])&&this._setSelectedRaster(a)},setImage:function(a,c){if(!a)return console.error("Object ID of raster to be displayed not provided");
var b=this,d,f;this.imageSpatialReference=new C({icsid:a,url:this.imageServiceUrl});this.projectGeometry(this._adjustExtentAspectRatio(c),this.imageSpatialReference).then(function(c){if(!b._verifyExtent(c[0]))return console.log("Project operation returned invalid extent.");d=new m;d.method=m.METHOD_LOCKRASTER;d.lockRasterIds=[a];b.imageServiceLayer.setMosaicRule(d,!0);b._refreshOK=!1;b.map.spatialReference=c[0].spatialReference;f=e.defaults.map.zoomDuration;e.defaults.map.zoomDuration=0;b.map.setExtent((new n(c[0])).setSpatialReference(c[0].spatialReference)).then(function(){b._refreshOK=
!0;e.defaults.map.zoomDuration=f})})},search:function(a){if(!a)return console.error("Oblique viewer: no geometry provided for search.");var c,b=new v,d=this;c=new s;c.geometry=a;c.outFields=this._getQueryFields()||[this.imageServiceLayer.objectIdField,this.azimuthField];c.returnGeometry=!0;c.where=this.elevationField+"\x3c"+this.elevationThreshold;c.outSpatialReference=a.spatialReference;c.spatialRel="esriSpatialRelContains";this.obliqueRecordsQueryTask.execute(c).then(function(a){b.resolve({features:d.sorter(d._processRecords(a.features))})});
return b.promise},_sortSpatially:function(a){if(a&&a.length&&this.map.loaded){var c=0,b=0,d=a[0],f,r,e,g,c=0,k;k=(this.nadirExtent||this.map.extent).getCenter();this.selectedRaster&&this._extentContained(this.selectedRaster,this.nadirExtent)&&(h.some(a,function(b,c){if(b.attributes[this.imageServiceLayer.objectIdField]===this.selectedRasterId)return e=a[c],a[c]=d,a[0]=e,!0},this),c=1);for(;c<a.length;c++){f=Math.sqrt((a[c].center.x-k.x)*(a[c].center.x-k.x)+(a[c].center.y-k.y)*(a[c].center.y-k.y));
g=c;for(b=c+1;b<a.length;b++)r=Math.sqrt((a[b].center.x-k.x)*(a[b].center.x-k.x)+(a[b].center.y-k.y)*(a[b].center.y-k.y)),f>r&&(d=a[b],f=r,g=b);c!==g&&(e=a[c],a[c]=d,a[g]=e)}}return a},_filterByAzimuth:function(){this.filteredRecords=[];h.forEach(this.records,function(a){Math.min(Math.abs(a.attributes[this.azimuthField]-this.azimuthAngle),Math.abs(a.attributes[this.azimuthField]-this.azimuthAngle-360))<=this.azimuthTolerance&&this.filteredRecords.push(a)},this);this.filteredRecords&&this.filteredRecords.length&&
(this.filteredRecords[0].attributes.selected=!0)},_processRecords:function(a){var c;h.forEach(a,function(a){c=(new p(a.geometry)).setSpatialReference(this.nadirSpatialReference).getCentroid();a.center=c},this);return a},_computeAzimuthFilter:function(){var a=(this.azimuthAngle+350)%360,c=(this.azimuthAngle+10)%360;return a<c?this.azimuthField+" BETWEEN "+a+" AND "+c:"("+this.azimuthField+" BETWEEN 0 AND "+c+" OR "+this.azimuthField+" BETWEEN "+a+" AND 360)"},_getIds:function(a){var c=[],b=this;h.forEach(a,
function(a){c.push(a.attributes[b.imageServiceLayer.objectIdField])});return c},_adjustExtentAspectRatio:function(a){var c,b;c=Math.min(a.ymax-a.ymin,a.xmax-a.ymin)/2;b=a.getCenter();new n(b.x-c,b.y-c,b.x+c,b.y+c,a.spatialReference);return a},_setRasterListRefreshAttr:function(a){this._set("rasterListRefresh",a);a&&this._refreshListDijit(this.isNadir?this.records:this.filteredRecords)},_extentContained:function(a,c){if(!a||!c)return!1;var b=(new p(a.geometry)).getExtent(),d,f,e;d=b.ymax-b.ymin;f=
b.xmax-b.xmin;d*=0.8;f*=0.8;e=b.getCenter();return(new n({xmin:e.x-f/2,ymin:e.y-d/2,xmax:e.x+f/2,ymax:e.y+d/2,spatialReference:b.spatialReference})).contains(c)},setData:function(a,c){if(!a)return console.error("Oblique viewer: records not provided.");c=c||this.map.extent;this._set("records",a);this._filterByAzimuth();if(this.filteredRecords&&this.filteredRecords.length)if(this._refreshListDijit(this.filteredRecords),this.imageServiceLayer.loaded)this._setSelectedRaster(c);else this.imageServiceLayer.on("load",
l.hitch(this,function(){this._setSelectedRaster(c)}));else this.selectedRasterId=this.selectedRaster=null,this.emit("raster-select",{selectedRasterId:null})},_setSelectedRaster:function(a){this.selectedRaster=this.filteredRecords[0];this.selectedRasterId=this.selectedRaster.attributes[this.imageServiceLayer.objectIdField];this.setImage(this.selectedRaster.attributes[this.imageServiceLayer.objectIdField],a);this.emit("raster-select",{selectedRasterId:this.selectedRasterId})},setExtent:function(a){var c=
new v,b=this;this.projectGeometry(a,this.map.spatialReference).then(function(a){b._verifyExtent(a[0])&&b.map.setExtent(a[0]).then(function(){c.resolve()})});return c.promise},zoomToSelectedImage:function(){if(!q.isDefined(this.selectedRasterId))return console.error("Oblique viewer: no selected raster.");if(this.isNadir)return console.log("Viewer in nadir mode, no selected raster.");var a=this,c;this._getImageGeometry(this.selectedRasterId,this.map.spatialReference).then(function(b){b.features&&b.features.length&&
(c=(new p(b.features[0].geometry)).setSpatialReference(a.map.spatialReference),a.map.setExtent(c.getExtent()))})},_getImageGeometry:function(a,c){var b=new s;b.objectIds=[a];b.returnGeometry=!0;b.outSpatialReference=c;return this.obliqueRecordsQueryTask.execute(b)},_getQueryFields:function(){var a=[];h.forEach(this.rasterInfoFields,function(c){c.name&&a.push(c.name)});0>h.indexOf(a,this.azimuthField)&&a.push(this.azimuthField);0>h.indexOf(a,this.imageServiceLayer.objectIdField)&&a.push(this.imageServiceLayer.objectIdField);
return a}});w("extend-esri")&&l.setObject("dijit.ObliqueViewer",g,x);return g});