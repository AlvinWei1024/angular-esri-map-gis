// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.14/esri/copyright.txt for details.
//>>built
require({cache:{"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(x,J,t,h){var p=function(h,l){return h-l},w={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(h){var l=String(h),n=l.match(w._reNumber);h={integer:0,fractional:0};n&&n[1]?(h.integer=n[1].split("").length,h.fractional=n[3]?n[3].split("").length:0):-1<l.toLowerCase().indexOf("e")&&(n=l.split("e"),l=n[0],n=n[1],l&&n&&(l=Number(l),n=Number(n),(h=0<n)||(n=Math.abs(n)),
l=w.getDigits(l),h?(l.integer+=n,l.fractional=n>l.fractional?0:l.fractional-n):(l.fractional+=n,l.integer=n>l.integer?1:l.integer-n),h=l));return h},getFixedNumbers:function(h,l){var n,p;n=Number(h.toFixed(l));p=n<h?n+1/Math.pow(10,l):n-1/Math.pow(10,l);return[n,p]},getPctChange:function(h,l,n,p){var t={prev:null,next:null},r;null!=n&&(r=h-n,n=l-n-r,t.prev=Math.floor(Math.abs(100*n/r)));null!=p&&(r=p-h,n=p-l-r,t.next=Math.floor(Math.abs(100*n/r)));return t},round:function(h,l){var n=h.slice(0),t,
N,r,g,u,y,F,x,v,J=!l||null==l.tolerance?2:l.tolerance,B=l&&l.indexes;if(B)B.sort(p);else{B=[];for(y=0;y<n.length;y++)B.push(y)}for(y=0;y<B.length;y++)if(v=B[y],t=n[v],N=0===v?null:n[v-1],r=v===n.length-1?null:n[v+1],g=w.getDigits(t),g=g.fractional){F=0;for(x=!1;F<=g&&!x;)u=w.getFixedNumbers(t,F),u=u[0],x=w.hasMinimalChange(t,u,N,r,J),F++;x&&(n[v]=u)}return n},hasMinimalChange:function(h,l,n,t,p){h=w.getPctChange(h,l,n,t);l=null==h.prev||h.prev<=p;n=null==h.next||h.next<=p;return l&&n||h.prev+h.next<=
2*p},_reAllZeros:RegExp("\\"+t.decimal+"0+$","g"),_reSomeZeros:RegExp("(\\d)0*$","g"),format:function(h,l){l=l||{places:20,round:-1};var n=J.format(h,l);n&&(n=n.replace(w._reSomeZeros,"$1").replace(w._reAllZeros,""));return n}};x("extend-esri")&&(h.numberUtils=w);return w})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/has dojo/sniff dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(x,
J,t,h,p,w,M,l,n,U,N,r,g,u,y,F,V,v,W,B,R,K,C,I,O,L,X,Y,Z,Q,S,$,P,aa,T){var G=J([aa,y],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,defaultText:"Aa",gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,constructor:function(a,b){t.mixin(this,T.widgets.legend);this._i18n=T.widgets.legend;a=a||{};a.map?
b?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this.arrangement=a.arrangement===G.ALIGN_RIGHT?G.ALIGN_RIGHT:G.ALIGN_LEFT,this.arrangement===G.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=[],this.hideLayersInLegend={}):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},
postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],b,c;for(b=0;b<a.length;b+=1)c=a[b],x.locale&&-1!==x.locale.indexOf(c)&&(-1!==x.locale.indexOf("-")?-1!==x.locale.indexOf(c+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},
startup:function(){this.inherited(arguments);this._initialize();9>l("ie")&&(this._repaintItems=t.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeHoverHandlers();this.inherited(arguments)},refresh:function(a){if(this.domNode){a?(this.layerInfos=a,this.layers=[],h.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?
!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=null);for(a=this.domNode.children.length-1;0<=a;a--)g.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",
_initialize:function(){this.layerInfos&&(this.layers=[],h.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=
!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],b=[];h.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);var d;this._isSupportedLayerType(c)&&(c.arcgisProps&&c.arcgisProps.title&&(c._titleForLegend=c.arcgisProps.title),this.layers.push(c));"esri.layers.KMLLayer"==c.declaredClass&&(d=c.getLayers(),h.forEach(d,function(b){a.push(b.id)},this));"esri.layers.GeoRSSLayer"==c.declaredClass&&(d=c.getFeatureLayers(),h.forEach(d,function(a){b.push(a.id)},this))},this);h.forEach(this.map.graphicsLayerIds,
function(c){var d=this.map.getLayer(c);-1==h.indexOf(a,c)&&-1==h.indexOf(b,c)&&(this._isSupportedLayerType(d)&&d._params&&d._params.drawMode)&&(d.arcgisProps&&d.arcgisProps.title&&(d._titleForLegend=d.arcgisProps.title),this.layers.push(d))},this)}this._createLegend()},_activate:function(){this._deactivate();this.autoUpdate&&(this._respectCurrentMapScale&&(this._ozeConnect=p.connect(this.map,"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(this._olaConnect=p.connect(this.map,"onLayerAdd",
this,"_updateAllMapLayers"),this._olrConnect=p.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers"),this._olroConnect=p.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers")),h.forEach(this.layers,function(a){a.ovcConnect=p.connect(a,"onVisibilityChange",this,"_refreshLayers");a.oscConnect=p.connect(a,"onScaleRangeChange",this,"_refreshLayers");"esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass&&a.supportsDynamicLayers&&(a.odcConnect=p.connect(a,"_onDynamicLayersChange",
t.hitch(this,"_updateDynamicLayers",a)));"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&(a.oirConnect=p.connect(a,"onRenderingChange",t.partial(this._updateImageServiceLayers,this,a)));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&(a.oivrConnect=p.connect(a,"onRendererChange",t.hitch(this,"_refreshLayers")))},this))},_deactivate:function(){this._ozeConnect&&p.disconnect(this._ozeConnect);this._olaConnect&&p.disconnect(this._olaConnect);this._olroConnect&&p.disconnect(this._olroConnect);
this._olrConnect&&p.disconnect(this._olrConnect);h.forEach(this.layers,function(a){a.ovcConnect&&p.disconnect(a.ovcConnect);a.oscConnect&&p.disconnect(a.oscConnect);a.odcConnect&&p.disconnect(a.odcConnect);a.oirConnect&&p.disconnect(a.oirConnect);a.oivrConnect&&p.disconnect(a.oivrConnect)},this)},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},
_updateAllMapLayers:function(){this.layers=[];h.forEach(this.map.layerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this.layers.push(a)},this);h.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&(a._params&&a._params.drawMode)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1;u.set(this.domNode,"position","relative");g.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+
"..."},this.domNode);var b=[];h.forEach(this.layers,function(c){if("esri.layers.KMLLayer"==c.declaredClass||"esri.layers.GeoRSSLayer"==c.declaredClass){var e;c.loaded?("esri.layers.KMLLayer"==c.declaredClass?e=c.getLayers():"esri.layers.GeoRSSLayer"==c.declaredClass&&(e=c.getFeatureLayers(),this.hideLayersInLegend[c.id]&&(e=h.filter(e,function(a){return-1==h.indexOf(this.hideLayersInLegend[c.id],a.id)},this))),h.forEach(e,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&c._titleForLegend&&
(a._titleForLegend=c._titleForLegend+" - ","esriGeometryPoint"==a.geometryType?a._titleForLegend+=this.NLS_points:"esriGeometryPolyline"==a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==a.geometryType&&(a._titleForLegend+=this.NLS_polygons),b.push(a))},this)):p.connect(c,"onLoad",t.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===c.declaredClass)if(c.loaded){if((!this._respectVisibility||this._respectVisibility&&c.visible)&&0<c.layerInfos.length&&
h.some(c.layerInfos,function(a){return a.legendURL})){var f=!1;h.forEach(c.layerInfos,function(b){b.legendURL&&-1<h.indexOf(c.visibleLayers,b.name)&&(f||(g.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(c._titleForLegend||c.name||c.id)+"\x3c/span\x3e"},this.domNode),f=!0),g.create("div",{innerHTML:"\x3cimg src\x3d'"+b.legendURL+"'/\x3e"},this.domNode),a=!0)},this)}}else p.connect(c,"onLoad",t.hitch(this,function(){this.refresh(this.layerInfos)}));else b.push(c)},this);var c=
[];h.forEach(b,function(a){if(a.loaded){if((!this._respectVisibility||this._respectVisibility&&a.visible)&&(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass)){var b=g.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esriLegendService"});g.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},g.create("td",{align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},b)))));g.place(b,this.id,"first");
a.legendResponse||a.renderer?this._createLegendForLayer(a):c.push(this._legendRequest(a))}}else var f=p.connect(a,"onLoad",this,function(a){p.disconnect(f);f=null;this.refresh()})},this);0===c.length&&!a?(r.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate()):(new U(c)).addCallback(t.hitch(this,function(b){a?r.byId(this.id+"_msg").innerHTML="":r.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate()}))},_createLegendForLayer:function(a){if(a.legendResponse||a.renderer){var b=
!1;if(a.legendResponse){var c=a.dynamicLayerInfos||a.layerInfos;c&&c.length?h.forEach(c,function(c,e){if(!this.hideLayersInLegend[a.id]||-1==h.indexOf(this.hideLayersInLegend[a.id],c.id)){var f=this._buildLegendItems(a,c,e);b=b||f}},this):"esri.layers.ArcGISImageServiceLayer"==a.declaredClass&&(b=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},0))}else a.renderer&&(c=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,
{id:c,name:null,subLayerIds:null,parentLayerId:-1},0));b&&(u.set(r.byId(this.id+"_"+a.id),"display","block"),u.set(r.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=a.version?this._legendRequestServer(a):this._legendRequestTools(a);p.connect(a,"onLoad",t.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var b=a.url,c=b.indexOf("?"),b=-1<c?b.substring(0,c)+"/legend"+b.substring(c):b+"/legend";(c=a._getToken())&&(b+="?token\x3d"+c);var d=
t.hitch(this,"_processLegendResponse"),c={f:"json"};a._params.dynamicLayers&&(c.dynamicLayers=N.stringify(this._createDynamicLayers(a)),"[{}]"===c.dynamicLayers&&(c.dynamicLayers="[]"));a._params.bandIds&&(c.bandIds=a._params.bandIds);a._params.renderingRule&&(c.renderingRule=a._params.renderingRule);return R({url:b,content:c,callbackParamName:"callback",load:function(b,c){d(a,b,c)},error:B.defaults.io.errorHandler})},_legendRequestTools:function(a){var b=a.url.toLowerCase().indexOf("/rest/"),b=a.url.substring(0,
b)+a.url.substring(b+5,a.url.length),b=this._legendUrl+"?soapUrl\x3d"+window.escape(b);if(!l("ie")||8<l("ie"))b+="\x26returnbytes\x3dtrue";var c=t.hitch(this,"_processLegendResponse");return R({url:b,content:{f:"json"},callbackParamName:"callback",load:function(b,e){c(a,b,e)},error:B.defaults.io.errorHandler})},_processLegendResponse:function(a,b){b&&b.layers?(a.legendResponse=b,r.byId(this.id+"_"+a.id)&&g.empty(r.byId(this.id+"_"+a.id)),g.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},
g.create("td",{align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},r.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):console.log("Legend could not get generated for "+a.url+": "+w.toJson(b))},_buildLegendItems:function(a,b,c){var d=!1,e=r.byId(this.id+"_"+a.id),f=b.parentLayerId;if(b.subLayerIds)a=g.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==f?0<c?"esriLegendGroupLayer":"":this._legendAlign},-1==f?e:r.byId(this.id+
"_"+a.id+"_"+f+"_group")),g.create("td",{innerHTML:v.encode(b.name),align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%","class":"esriLegendLayerLabel"},a))));else{if(a.visibleLayers&&-1==(","+a.visibleLayers+",").indexOf(","+b.id+","))return d;c=g.create("div",{id:this.id+"_"+a.id+"_"+b.id,style:{display:"none"},"class":-1<f?this._legendAlign:""},-1==f?e:r.byId(this.id+"_"+a.id+"_"+f+"_group"));g.create("td",{innerHTML:v.encode(b.name)||"",align:this._align},g.create("tr",
{},g.create("tbody",{},g.create("table",{width:"95%","class":"esriLegendLayerLabel"},c))));a.legendResponse?d=d||this._buildLegendItems_Tools(a,b,c):a.renderer&&(d=d||this._buildLegendItems_Renderer(a,b,c))}return d},_buildLegendItems_Tools:function(a,b,c){var d=b.parentLayerId,e=this.map.getScale(),f=!1,q=function(a,b){var c,d;for(c=0;c<a.length;c++)if(b.dynamicLayerInfos)for(d=0;d<b.dynamicLayerInfos[d].length;d++){if(b.dynamicLayerInfos[d].mapLayerId==a[c].layerId)return a[c]}else if(b.id==a[c].layerId)return a[c];
return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(a,b,e)){var s=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var m=this._getEffectiveScale(a,b);if(m.minScale&&m.minScale<e||m.maxScale&&m.maxScale>e)s=!1}if(s){var e=q(a.legendResponse.layers,b),k=e.legendType,l=e.legend;if(l){"esri.layers.ArcGISImageServiceLayer"!==a.declaredClass&&this._sanitizeLegendResponse(a,
e,b);c=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);var n=g.create("tbody",{},c);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(c,a,b);h.forEach(l,function(c){if(!(10.1<=a.version&&!c.values&&1<l.length&&(a._hideDefaultSymbol||"\x3call other values\x3e"===c.label||!c.label&&!("esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.3<=a.version))))if(c.url&&0===c.url.indexOf("http")||c.imageData&&0<c.imageData.length)f=!0,this._buildRow_Tools(c,
n,a,b.id,k)},this)}}}f&&(u.set(r.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<d&&(u.set(r.byId(this.id+"_"+a.id+"_"+d+"_group"),"display","block"),this._findParentGroup(a.id,a,d)));return f},_sanitizeLegendResponse:function(a,b,c){var d=b.legend;if(10.1<=a.version&&1<d.length&&!b._sanitized){a=t.getObject("layerDefinition.drawingInfo.renderer",!1,c);var e,f;a||(a=t.getObject("drawingInfo.renderer",!1,c));h.some(d,function(a,b){a.values||(f=b,e=a);return!!e});a?"uniqueValue"===a.type?e&&(d.splice(f,
1),d.push(e)):"classBreaks"===a.type&&(e&&d.splice(f,1),d.reverse(),e&&d.push(e)):e&&(d.splice(f,1),d.push(e));b._sanitized=!0}},_buildRow_Tools:function(a,b,c,d,e){var f=g.create("tr",{},b),q;this.alignRight?(b=g.create("td",{align:this._isRightToLeft?"left":"right"},f),q=g.create("td",{align:this._isRightToLeft?"left":"right",width:35},f)):(q=g.create("td",{width:35,align:"center"},f),b=g.create("td",{},f));f=a.url;(!l("ie")||9<=l("ie")||9>l("ie")&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass)&&
a.imageData&&0<a.imageData.length?f="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(f=c.url+"/"+d+"/images/"+a.url,(d=c._getToken())&&(f+="?token\x3d"+d));d=g.create("img",{src:f,border:0,style:"opacity:"+c.opacity},q);a=g.create("td",{innerHTML:v.encode(a.label),align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%",dir:"ltr"},b))));e&&("Stretched"===e&&10.3<=c.version&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass)&&(a.style.verticalAlign=
"top",a.style.lineHeight="1",d.style.marginBottom="-1px",d.style.display="block",b.style.verticalAlign="top");9>l("ie")&&(d.style.filter="alpha(opacity\x3d"+100*c.opacity+")")},_getVariable:function(a,b,c){var d;a&&(d=(a=a.getVisualVariablesForType(b,c))&&a[0]);return d},_getFieldAlias:function(a,b){var c=b.infoTemplate,c=c&&c.getFieldInfo&&c.getFieldInfo(a),d=t.isFunction(a)?null:b.getField(a),e=c||d,f="";e&&(f=c&&c.label||d&&d.alias||e.name||e.fieldName);return f},_getDefaultHoverLabel:function(a,
b){var c;if(a){var d=this._getVariable(a,"colorInfo",!1),e=this._getVariable(a,"opacityInfo",!1),f=this._getVariable(a,"sizeInfo",!1),d=d||f||e,q,s,m,k,g;a instanceof S?q=a.field:a instanceof O&&!a.attributeField2&&!a.attributeField3?(q=a.attributeField,d&&(m=d.field,k=d.normalizationField)):a instanceof L?d?(q=d.field,s=d.normalizationField):(q=a.attributeField,s=a.normalizationField,g="percent-of-total"===a.normalizationType):a instanceof I&&d&&(q=d.field,s=d.normalizationField);(g=k&&"showOpNormField"||
m&&"showOpField"||s&&"showNormField"||(g?"showNormPct":null)||q&&"showField"||null)&&(c=K.substitute({field:q&&this._getFieldAlias(q,b),normField:s&&this._getFieldAlias(s,b),opField:m&&this._getFieldAlias(m,b),opNormField:k&&this._getFieldAlias(k,b)},this._i18n[g]))}return c},_buildLegendItems_Renderer:function(a,b,c){var d=b.parentLayerId,e=this.map,f=e.getScale(),q=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,b,f)){var s,m,k="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?
a.renderer.renderer:a.renderer,l,n,A,p,E,D;if(k instanceof X&&(k=(e="zoom"===k.rangeType?k.getRendererInfoByZoom(e.getZoom()):k.getRendererInfoByScale(f))&&e.renderer,!k))return!1;var e=this._getVariable(k,"colorInfo",!1),f=this._getVariable(k,"opacityInfo",!1),H=this._getVariable(k,"sizeInfo",!1),z=this._getDefaultHoverLabel(k,a);e?(l=this._getMedianColor(k,e),e.field&&(A=t.isFunction(e.field)?null:a.getField(e.field))):f&&(E=t.isFunction(f.field)?null:a.getField(f.field),D=f.normalizationField);
H&&H.field&&(p=t.isFunction(H.field)?null:a.getField(H.field));if(k instanceof S)q=!0,this._showHeatRamp(a,b,k,c,z);else if(k instanceof Y)q=!0,this._showDotDensityLegend(a,b,k,c);else if(k instanceof Z)q=!0,m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),s=g.create("tbody",{},m),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(m,a,b),k.latestObservationRenderer&&k.latestObservationRenderer instanceof I&&this._buildRow_Renderer(a,k.latestObservationRenderer.symbol,
l,v.encode(k.latestObservationRenderer.label)||this.NLS_currentObservations,null,s),k.observationRenderer&&k.observationRenderer instanceof I&&this._buildRow_Renderer(a,k.observationRenderer.symbol,l,v.encode(k.observationRenderer.label)||this.NLS_previousObservations,null,s);else if(k instanceof O){if(k.infos&&0<k.infos.length){q=!0;m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);s=g.create("tbody",{},m);(a._hoverLabel||a._hoverLabels||z)&&this._createHoverAction(m,
a,b,z);var w=[];h.forEach(k.infos,function(b){var c=null;a._editable&&a.types&&(c=this._getTemplateFromTypes(a.types,b.value));var d=b.label;null==d&&(d=b.value);-1===h.indexOf(w,d)&&(w.push(d),this._buildRow_Renderer(a,b.symbol,l,v.encode(d),c,s))},this)}}else if(k instanceof L){if(k.infos&&0<k.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass){q=!0;D=A||p||E;if(!D||!this._isSmartRenderer(k,D.name))m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},
c),s=g.create("tbody",{},m),D=(k.normalizationField||"percent-of-total"===k.normalizationType)&&z?z:this._getFieldAlias(k.attributeField,a),this._buildRow_Renderer(a,null,l,v.encode(D),null,s);m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);s=g.create("tbody",{},m);(a._hoverLabel||a._hoverLabels||z)&&this._createHoverAction(m,a,b,z);D=k.infos.slice(0).reverse();h.forEach(D,function(b){var c=b.label;null==c&&(c=(c=A||p||E)&&this._isSmartRenderer(k,c.name)?
k.normalizationField&&z?z:this._getFieldAlias(c.name,a):b.minValue+" - "+b.maxValue);this._buildRow_Renderer(a,b.symbol,l,v.encode(c),null,s)},this);if("esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&(a.renderer.style===Q.STYLE_SCALAR||a.renderer.style===Q.STYLE_SINGLE_ARROW))this._buildRow_Renderer(a,k.defaultSymbol,null,"",null,s),a._hideDefaultSymbol=!0}}else k instanceof I&&(q=!0,m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),s=g.create("tbody",
{},m),(a._hoverLabel||a._hoverLabels||z)&&this._createHoverAction(m,a,b,z),n=null,a._editable&&(a.templates&&0<a.templates.length)&&(n=a.templates[0]),m=(A||E)&&p?null:A||E||p,this._buildRow_Renderer(a,k.symbol,l,v.encode(D&&z?z:m?this._getFieldAlias(m.name,a):k.label),n,s),n=k.symbol&&k.symbol.color,m&&(A=E=p=null));q&&(e&&e.field?(A&&this._isSmartRenderer(k,A.name)&&(A=null),this._showColorRamp(a,b,k,null,c,e,A,z)):f&&n&&this._showColorRamp(a,b,k,n,c,f,E,z),H&&H.field&&(p&&this._isSmartRenderer(k,
p.name)&&(p=null),this._showSizeLegend(a,b,k,H,l,c,p,z)));!a._hideDefaultSymbol&&k.defaultSymbol&&(q=!0,m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),s=g.create("tbody",{},m),this._buildRow_Renderer(a,k.defaultSymbol,null,v.encode(k.defaultLabel)||"others",null,s))}q&&(u.set(r.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<d&&(u.set(r.byId(this.id+"_"+a.id+"_"+d+"_group"),"display","block"),this._findParentGroup(a.id,d)));return q},_isSmartRenderer:function(a,
b){return a instanceof L&&a.infos&&1===a.infos.length&&a.attributeField===b},_showColorRamp:function(a,b,c,d,e,f,q,s){var m;m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},e);e=g.create("tbody",{},m);(a._hoverLabel||a._hoverLabels||s)&&this._createHoverAction(m,a,b,s);q&&this._addSubHeader(e,this._getFieldAlias(q.name,a));b=this._getRampStops(c,f,d);b.length&&this._drawColorRamp(e,b,!0,a,this._getRampBorderColor(c))},_getMedianColor:function(a,b){var c,d;b.colors?
(c=b.minDataValue,d=b.maxDataValue):b.stops&&(c=b.stops[0].value,d=b.stops[b.stops.length-1].value);return a.getColor(c+(d-c)/2,{colorInfo:b})},_getRampStops:function(a,b,c){var d,e,f,q,g=!1;b.colors||b.opacityValues?(e=b.maxDataValue-b.minDataValue,d=h.map([0,0.25,0.5,0.75,1],function(a){f=b.minDataValue+a*e;return Number(f.toFixed(6))}),this._checkPrecision(0,4,d)):b.stops&&(d=h.map(b.stops,function(a){return a.value}),(g=h.some(b.stops,function(a){return!!a.label}))&&(q=h.map(b.stops,function(a){return a.label})));
var m=d[0],k,l,n;e=d[d.length-1]-m;return h.map(d,function(f,h){c?(k=new M(c.toRgba()),l=a.getOpacity(f,{opacityInfo:b}),null!=l&&(k.a=l)):k=a.getColor(f,{colorInfo:b});n="";0===h?n=this._specialChars.lt+" ":h===d.length-1&&(n=this._specialChars.gt+" ");return{value:f,color:k,offset:1-(f-m)/e,label:g?q[h]:n+C.format(f)}},this).reverse()},_checkPrecision:function(a,b,c){var d=a+(b-a)/2,e=c[a],f=c[d],q=c[b],g=Math.floor(e),m=Math.floor(f),k=Math.floor(q);g===e&&(k===q&&m!==f&&g!==m&&k!==m)&&(c[d]=m);
a+1!==d&&this._checkPrecision(a,d,c);d+1!==b&&this._checkPrecision(d,b,c)},_getRampBorderColor:function(a){var b;if(a instanceof I)b=a.symbol;else if(a instanceof O||a instanceof L)b=a.infos[0].symbol;return(a=b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawColorRamp:function(a,b,c,d,e){var f=g.create("tr",{},a),q,s,m,k,n,p=b.length-1,t;k=0;this.alignRight?(a=g.create("td",{align:this._isRightToLeft?"left":"right"},f),q=g.create("td",{align:this._isRightToLeft?"left":"right",
width:this.gradientWidth},f)):(q=g.create("td",{width:this.gradientWidth,align:"center"},f),a=g.create("td",{},f));var r=e&&0<e.a&&!(240<=e.r&&240<=e.g&&240<=e.b);s=g.create("div",{"class":r?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},q);f=g.create("div",{"class":"esriLegendColorRamp"},s);q=u.get(f,"width");r&&(e=9>l("ie")?e.toHex():"rgba("+e.toRgba().join(",")+")",u.set(f,"border",this.colorRampBorder+" "+e));c?(e=this.gradientHeight*p,u.set(f,
"height",e+"px")):e=u.get(f,"height");u.set(s,"height",e+"px");f=F.createSurface(f,q,e);9>l("ie")&&(k=f.getEventSource(),u.set(k,"position","relative"),u.set(k.parentNode,"position","relative"),k=1);try{c&&h.forEach(b,function(a,b){a.offset=b/p}),n=f.createRect({x:-k,y:-k,width:q+k,height:e+k}),n.setFill({type:"linear",x1:0,y1:0,x2:0,y2:e,colors:b}).setStroke(null),f.createRect({width:q,height:e}).setFill(new M([255,255,255,1-d.opacity])).setStroke(null),this._surfaceItems.push(f)}catch(E){f.clear(),
f.destroy()}h.forEach(b,function(a,c){if(a.label){t="top:"+100*a.offset+"%;";var d="";0===c&&(d+=" esriLegendColorRampTickFirst");c===b.length-1&&(d+=" esriLegendColorRampTickLast");g.create("div",{"class":"esriLegendColorRampTick"+d,innerHTML:"\x26nbsp;",style:t},s)}});m=g.create("div",{"class":"esriLegendColorRampLabels",style:{height:e+this.gradientHeight+"px"}},a);c?h.forEach(b,function(a){g.create("div",{"class":"esriLegendColorRampLabel",innerHTML:v.encode(a.label)||"\x26nbsp;"},m)}):(g.create("div",
{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.high},m),g.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.low,style:"top: "+(e+this.gradientHeight-2*this.gradientHeight)+"px;"},m))},_showHeatRamp:function(a,b,c,d,e){var f,q=c.field;f=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d);d=g.create("tbody",{},f);(a._hoverLabel||a._hoverLabels||e)&&this._createHoverAction(f,a,b,e);(q=q&&a.getField(q))&&this._addSubHeader(d,this._getFieldAlias(q.name,
a));b=this._getHeatmapStops(c);b.length&&this._drawColorRamp(d,b,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;var c,d,e,f;if(b&&b[0])if(c=b.length-1,a=b[0]&&null!=b[0].ratio){if((a=b[c])&&1!==a.ratio)b=b.slice(0),b.push({ratio:1,color:a.color}),c++}else d=b[0].value,e=b[c].value-d,b=h.map(b,function(a){return{color:a.color,ratio:(a.value-d)/e}});else a&&a[0]&&(c=a.length-1,f=1/(a.length-1),b=h.map(a,function(a,b){return{color:a,ratio:b*f}}));b=h.map(b,function(a,b){var d="";0===
b?d="Low":b===c&&(d="High");return{color:a.color,label:d,offset:1-a.ratio}});return b.reverse()},_showDotDensityLegend:function(a,b,c,d){var e=c.legendOptions,f,q,s,m,k,l,n,p=this.dotDensitySwatchSize,r=Math.round(p/2);e&&(q=e.backgroundColor,s=e.outline,m=e.valueUnit,k=e.dotCoverage);k=(k||this.dotCoverage)/100;n=Math.round(p*p/Math.pow(c.dotSize,2)*k);d=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d);l=g.create("tbody",{},d);(a._hoverLabel||a._hoverLabels)&&
this._createHoverAction(d,a,b);this._addSubHeader(l,K.substitute({value:c.dotValue,unit:m||""},this.NLS_dotValue));h.forEach(c.fields,function(b){b=t.mixin({},b);b.numPoints=n;f=new $(c._generateImageSrc(p,p,[b],{x:0,y:0},{x:p,y:p},q),s||c.outline,p,p);b=a.getField(b.name)||b;this._buildRow_Renderer(a,f,null,v.encode(this._getFieldAlias(b.name,a)),null,l,{type:"path",path:"M "+-r+","+-r+" L "+r+","+-r+" L "+r+","+r+" L "+-r+","+r+" L "+-r+","+-r+" E"})},this)},_showSizeLegend:function(a,b,c,d,e,f,
q,s){var m=d.legendOptions,m=m&&m.customValues,k,l,n=this._getSizeSymbol(c,e);"unknown"!==d.valueUnit||(!n||!m&&(null==d.minSize||null==d.maxSize))||(e=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},f),k=g.create("tbody",{},e),(a._hoverLabel||a._hoverLabels||s)&&this._createHoverAction(e,a,b,s),q&&this._addSubHeader(k,this._getFieldAlias(q.name,a)),l=m||this._getDataValues(c,n,d),l.reverse(),h.forEach(l,function(b,e){n=P.fromJson(n.toJson());this._applySize(n,
c,d,b);b=C.format(b);var f="";0===e?f=this._specialChars.gt+" ":e===l.length-1&&(f=this._specialChars.lt+" ");f="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+v.encode(f+b)+"\x3c/span\x3e";this._buildRow_Renderer(a,n,null,f,null,k)},this))},_getSizeSymbol:function(a,b){var c;if(a instanceof I)c=a.symbol;else if(a instanceof Q)c=a.defaultSymbol;else if(a instanceof O||a instanceof L)c=a.infos[0].symbol;if(c=-1!==c.type.indexOf("fillsymbol")?null:c)c=P.fromJson(c.toJson()),b&&c.setColor(new M(b.toRgba()));
return c},_getDataValues:function(a,b,c,d,e){d=null==d?5:d;e=null==e?20:e;var f=a.getSizeRangeAtScale(c,this.map.getScale());d=this._interpolateSizeRange(f,d);var g=h.map(d,function(a){return this._getDataValueFromSize(a,c,f)},this),s,m,g=C.round(g);for(s=1;s<g.length-1;s++)if(m=this._roundDataValue(a,b,c,g[s],g[s-1],e))g[s]=m[0],d[s]=m[1];return g},_interpolateSizeRange:function(a,b){var c=a.minSize,d=(a.maxSize-c)/(b-1),e,f=[];for(e=0;e<b;e++)f.push(c+d*e);return f},_getDataValueFromSize:function(a,
b,c){var d=c.minSize;c=c.maxSize;var e=b.minDataValue;b=b.maxDataValue;return a=a<=d?e:a>=c?b:(a-d)/(c-d)*(b-e)+e},_roundDataValue:function(a,b,c,d,e,f){var g=this._getSize(b,a,c,d);e=this._getSize(b,a,c,e);var s,m=C.getDigits(d),k=m.integer,m=m.fractional,h,l,n,p,r,t,u,v,w,x,y;0<d&&1>d&&(s=Math.pow(10,m),d*=s,k=C.getDigits(d).integer);for(k-=1;0<=k&&!(h=Math.pow(10,k),m=Math.floor(d/h)*h,h*=Math.ceil(d/h),null!=s&&(m/=s,h/=s),l=(m+h)/2,l=C.round([m,l,h],{indexes:[1]})[1],n=this._getSize(b,a,c,m),
p=this._getSize(b,a,c,h),r=this._getSize(b,a,c,l),t=C.getPctChange(g,n,e,null),u=C.getPctChange(g,p,e,null),v=C.getPctChange(g,r,e,null),w=t.prev<=f,x=u.prev<=f,w&&x&&(t.prev<=u.prev?(w=!0,x=!1):(x=!0,w=!1)),w?y=[m,n]:x?y=[h,p]:v.prev<=f&&(y=[l,r]),y);k--);return y},_applySize:function(a,b,c,d){var e=a.type;b=this._getSize(a,b,c,d);switch(e){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":e=a.width;c=a.height;a.setHeight(b);a.setWidth(b*(e/c));break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);
break;case "textsymbol":a.font&&a.font.setSize(b)}},_getSize:function(a,b,c,d){return b.getSize(d,{sizeInfo:c,scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?a.style:null})},_buildRow_Renderer:function(a,b,c,d,e,f,h){var l=g.create("tr",{},f),m;this.alignRight?(f=g.create("td",{align:this._isRightToLeft?"left":"right"},l),b&&(m=g.create("td",{align:this._isRightToLeft?"left":"right",width:35},l))):(b&&(m=g.create("td",{width:35,align:"center"},l)),f=g.create("td",{},l));var k=
l=30;if(b){if("simplemarkersymbol"==b.type)l=Math.min(Math.max(l,b.size+12),125),k=Math.min(Math.max(k,b.size+12),125);else if("picturemarkersymbol"==b.type)l=Math.min(Math.max(l,b.width),125),k=Math.min(b.height||k,125);else if("textsymbol"==b.type){var n,p;b.text||(n=b.text,p=!0,b.setText(this.defaultText));l=Math.min(Math.max(l,b.getWidth()+12),125);k=Math.min(Math.max(k,b.getHeight()+12),125);p&&b.setText(n)}var r=g.create("div",{style:"width:"+l+"px;height:"+k+"px;"},m)}K.isDefined(d)&&"number"===
typeof d&&(d=""+d);g.create("td",{innerHTML:d||"",align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},f))));b&&(a=this._drawSymbol(r,b,c,l,k,e,a,h),this._surfaceItems.push(a))},_addSubHeader:function(a,b){var c=g.create("tr",{},a),c=g.create("td",{align:this._align,colspan:2},c);g.create("td",{innerHTML:v.encode(b)||"",align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},c))))},_drawSymbol:function(a,b,c,d,e,f,g,h){b=P.fromJson(b.toJson());
var m=g.opacity;c&&b.setColor(new M(c.toRgba()));if("simplelinesymbol"===b.type||"cartographiclinesymbol"===b.type||"textsymbol"===b.type){if(!b.color)return;c=b.color.toRgba();c[3]*=m;b.color.setColor(c)}else"simplemarkersymbol"===b.type||"simplefillsymbol"===b.type?(b.color&&(c=b.color.toRgba(),c[3]*=m,b.color.setColor(c)),b.outline&&b.outline.color&&(c=b.outline.color.toRgba(),c[3]*=m,b.outline.color.setColor(c))):"picturemarkersymbol"===b.type&&(a.style.opacity=m,a.style.filter="alpha(opacity\x3d("+
100*m+"))");a=F.createSurface(a,d,e);9>l("ie")&&(c=a.getEventSource(),u.set(c,"position","relative"),u.set(c.parentNode,"position","relative"));f=this._getDrawingToolShape(b,f)||P.getShapeDescriptors(b);var k,m=(c=f.defaultShape)&&"text"===c.type;try{m&&!c.text&&(c.text=this.defaultText),k=a.createShape(h||c).setFill(f.fill).setStroke(f.stroke),m&&k.setFont(f.font)}catch(n){a.clear();a.destroy();return}var p=k.getBoundingBox();h=p.width;f=p.height;var m=-(p.x+h/2),r=-(p.y+f/2);c=a.getDimensions();
m={dx:m+c.width/2,dy:r+c.height/2};if("simplemarkersymbol"===b.type&&"path"===b.style)d=g._getScaleMatrix(p,b.size),k.applyTransform(V.scaleAt(d.xx,d.yy,{x:c.width/2,y:c.height/2}));else if(h>d||f>e)g=h/d>f/e,d=((g?d:e)-5)/(g?h:f),t.mixin(m,{xx:d,yy:d});k.applyTransform(m);return a},_getDrawingToolShape:function(a,b){var c;switch(b?b.drawingTool||null:null){case "esriFeatureEditToolArrow":c={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolTriangle":c=
{type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case "esriFeatureEditToolRectangle":c={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case "esriFeatureEditToolCircle":c={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":c={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:c,fill:a.getFill(),stroke:a.getStroke()}},_repaintItems:function(){h.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},
_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(b){}a.children&&t.isArray(a.children)&&h.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,b,c,d){if(d=b._hoverLabel||b._hoverLabels&&b._hoverLabels[c.id]||d)d=v.encode(d),b.mouseMoveHandler=b.mouseMoveHandler||{},b.mouseMoveHandler[c.id]=p.connect(a,"onmousemove",t.hitch(this,function(a,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&
(this.hoverLabelShowing=!1,u.set(r.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(t.hitch(this,function(a,b,c){if(a==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,r.byId(this.id+"_hoverLabel")){var d=r.byId(this.id+"_hoverLabel");d.innerHTML="\x3cspan\x3e"+c+"\x3c/span\x3e";u.set(d,"top",b+"px");u.set(d,"left",a+15+"px");u.set(d,"display","")}else g.create("div",{innerHTML:"\x3cspan\x3e"+c+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",
style:{top:b+"px",left:a+15+"px"}},document.body)},b.clientX,b.clientY,a),500)},d)),b.mouseOutHandler=b.mouseOutHandler||{},b.mouseOutHandler[c.id]=p.connect(a,"onmouseout",t.hitch(this,function(a){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,u.set(r.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;h.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)p.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)p.disconnect(b.mouseOutHandler[a])})},
_createDynamicLayers:function(a){var b=[],c;h.forEach(a.dynamicLayerInfos||a.layerInfos,function(d){c={id:d.id};c.source=d.source&&d.source.toJson();var e;a.layerDefinitions&&a.layerDefinitions[d.id]&&(e=a.layerDefinitions[d.id]);e&&(c.definitionExpression=e);var f;a.layerDrawingOptions&&a.layerDrawingOptions[d.id]&&(f=a.layerDrawingOptions[d.id]);f&&(c.drawingInfo=f.toJson());c.minScale=d.minScale||0;c.maxScale=d.maxScale||0;b.push(c)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<
a.length;c++)if(a[c].id==b&&a[c].templates&&0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var d,e=b.dynamicLayerInfos||b.layerInfos;for(d=0;d<e.length;d++)if(c==e[d].id){-1<e[d].parentLayerId&&(u.set(r.byId(this.id+"_"+a+"_"+e[d].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,e[d].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,d){var e=a.layer.dynamicLayerInfos||a.layer.layerInfos,f,g;for(f=0;f<e.length;f++)if(e[f].id===
c&&e[f].subLayerIds)for(g=0;g<e[f].subLayerIds.length;g++){var l=e[f].subLayerIds[g];-1===h.indexOf(d,l)&&(d.push(l),b(l,d))}}a.layer.layerInfos&&h.forEach(this.hideLayersInLegend[a.layer.id],function(c){b(c,this.hideLayersInLegend[a.layer.id])},this)},_isLayerInScale:function(a,b,c){var d,e=!0;if(a.legendResponse&&a.legendResponse.layers)for(d=0;d<a.legendResponse.layers.length;d++){var f=a.legendResponse.layers[d];if(b.id==f.layerId){var g,h;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?
(0==f.minScale&&a.tileInfo&&(g=a.tileInfo.lods[0].scale),0==f.maxScale&&a.tileInfo&&(h=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(g=Math.min(a.minScale,f.minScale)||a.minScale||f.minScale,h=Math.max(a.maxScale,f.maxScale));if(0<g&&g<c||h>c)e=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)e=!1;return e},_getServiceTitle:function(a){var b=a._titleForLegend;b||((b=a.url)?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),
b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+
a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],K.isDefined(a)&&(b+=" ("+a+")"));return v.encode(b)},_getEffectiveScale:function(a,b){var c=b.minScale,d=b.maxScale;if(K.isDefined(b.parentLayerId)){var e=a.layerInfos,f=b.parentLayerId,g;for(g=e.length-1;0<=g;g--)if(e[g].id==f)if(0==c&&0<e[g].minScale?c=e[g].minScale:0<c&&0==e[g].minScale||0<c&&0<e[g].minScale&&(c=Math.min(c,e[g].minScale)),d=Math.max(d||0,e[g].maxScale||0),-1<e[g].parentLayerId)f=e[g].parentLayerId;
else break}return{minScale:c,maxScale:d}},_isSupportedLayerType:function(a){return a&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===
a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass)?!0:!1}});t.mixin(G,{ALIGN_LEFT:0,ALIGN_RIGHT:1});l("extend-esri")&&t.setObject("dijit.Legend",G,W);return G});