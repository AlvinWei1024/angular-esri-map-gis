// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.14/esri/copyright.txt for details.
//>>built
define("esri/layers/rasterFormats/ImageCanvasDecoder",["require","dojo/_base/declare","dojo/Deferred","dojo/sniff"],function(n,q,r,s){var h;return q(null,{constructor:function(a){this.ctx=a.ctx;this._loadRasterFormatModule()},decode:function(a,e){if(!e.width||!e.height)throw"Native decoding requires the image format, width and height";var g=new r,b,f=new Uint8Array(a),d=this._getFormat(a);if("error"===d)throw"invalid format";"jpeg"===d&&(b=this._getMask(f,e));var l="",c,h;for(c=0;c<f.length;c+=65535)h=
f.subarray(c,c+65535>f.length-1?f.length-1:c+65535),l+=String.fromCharCode.apply(null,h);var f="data:image/"+d+";base64,"+window.btoa(l),k=new Image,p;k.src=f;var m=this;k.onload=function(){m.ctx.clearRect(0,0,e.width,e.height);m.ctx.drawImage(k,0,0);var a=m.ctx.getImageData(0,0,k.width,k.height);p=a.data;if(b)for(c=0;c<b.length;c++)p[4*c+3]=b[c]?255:0;m.ctx.putImageData(a,0,0);g.resolve(null)};k.onerror=function(){g.reject("cannot load image")};return g},_getFormat:function(a){a=new Uint8Array(a,
0,10);var e="error";255===a[0]&&216===a[1]?e="jpeg":137===a[0]&&(80===a[1]&&78===a[2]&&71===a[3])&&(e="png");return e},_getMask:function(a,e){var g;try{if(!h)throw"The zlib decoder module is not loaded.";var b=0,f=0,d=Math.round(a.length/2);1===d%2&&(d+=1);for(var l=a.length-2,b=d;b<l&&!(255===a[b]&&217===a[b+1]);b++);d=b+=2;if(d<a.length-1){var c=(new h(a.subarray(d))).getBytes();g=new Uint8Array(e.width*e.height);for(b=d=0;b<c.length;b++)for(f=7;0<=f;f--)g[d++]=c[b]>>f&1}}catch(n){}return g},_loadRasterFormatModule:function(){10>
s("ie")||n(["./Zlib"],function(a){h=a})}})});